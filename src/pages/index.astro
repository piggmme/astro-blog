---
import Card from '@/components/Card.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'
import { camelize } from '@/utils/string'
import '@/utils/dayjs'
import { dayFormat } from '@/utils/dayjs'
import { ChevronDownIcon } from '@radix-ui/react-icons'

interface Post {
  frontmatter: {
    title: string
    tags: string[]
    pubDate: string
    description: string
    image: {
      url: string
      alt?: string
    }
    bgcolor: string
    color: string
  }
  url?: string
}
const allPosts: Post[] = await Astro.glob('./posts/*/*.md')
const uniqueTags = [...new Set(allPosts.map(post => post.frontmatter.tags).flat())]
const tags = uniqueTags.map((tag) => {
  const filteredPosts = allPosts.filter(post => post.frontmatter.tags.includes(tag)) as Post[]
  filteredPosts.sort((a, b) => {
    const aDate = new Date(a.frontmatter.pubDate)
    const bDate = new Date(b.frontmatter.pubDate)
    return bDate.getTime() - aDate.getTime()
  })
  return {
    tag,
    posts: filteredPosts,
  }
}).sort((postA, postB) => {
  const findLatest = (posts: Post[]) => {
    return posts.reduce((prev, current) => {
      const prevDate = new Date(prev.frontmatter.pubDate)
      const currentDate = new Date(current.frontmatter.pubDate)
      return prevDate.getTime() > currentDate.getTime() ? prev : current
    })
  }
  const latestPostA = findLatest(postA.posts)
  const latestPostB = findLatest(postB.posts)

  const aDate = new Date(latestPostA.frontmatter.pubDate)
  const bDate = new Date(latestPostB.frontmatter.pubDate)
  return bDate.getTime() - aDate.getTime()
})

const POST_ITEM_MAX_COUNT = 2
---
<BaseLayout title='@dev_hee'>
  <section class='home-header'>
    <h1>@dev_hee</h1>
    <p>그림쟁이 개발자 데브희입니다. <br />저의 보조기억 장치에 오신 것을 환영합니다.</p>
  </section>

  {
    tags.map(({ tag, posts }) => (
      <section class='home-posts' data-tag={camelize(tag)}>
        <h2>#{camelize(tag)} ({posts.length})</h2>
        <ul class='post-list'>
          {posts.map((post, index) => (
            <li class:list={['post-item', index >= POST_ITEM_MAX_COUNT && 'post-item-hidden']}>
              <a href={post.url} class='post-link'>
                <div class='post-content'>
                  <h3 class='title'>
                    {post.frontmatter.title}
                  </h3>
                  <span>{post.frontmatter.description}</span>
                  <span class='subtitle'>{dayFormat(post.frontmatter.pubDate)}</span>
                </div>
                {
                post.frontmatter.image.url && (
                <div class='post-image'>
                  <img class='image' src={post.frontmatter.image.url} alt={post.frontmatter.image.alt} />
                </div>
                )}
              </a>
            </li>
          ))}
        </ul>
        {posts.length > POST_ITEM_MAX_COUNT && (
          <button class='expand-button' data-target={camelize(tag)}>
            더보기 <ChevronDownIcon width={16} height={16} />
          </button>
        )}
      </section>
    ))
  }
</BaseLayout>

<style lang='scss'>
  .home-header {
    margin-bottom: 24px;
    padding: 36px 0;
    h1 {
      font-size: rem(48px);
      font-weight: 700;
    }
    p {
      font-size: rem(18px);
      font-weight: 300;
      line-height: 1.3;
    }
  }

  .home-posts {
    margin-bottom: 48px;
    box-sizing: border-box;

    h2 {
      font-size: rem(24px);
      font-weight: 700;
      margin-bottom: 16px;
    }

    .post-list {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      width: 100%;
      box-sizing: border-box;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .post-item {
      flex: 0 0 auto;
      width: 100%;
      border-radius: 8px;
      border: 1px solid $grey-200;
      padding: 8px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.2s ease;

      &:hover {
        border-color: $grey-400;
      }

      .post-link {
        display: flex;
        flex-direction: row;
        gap: 16px;
        width: 100%;

        @media screen and (max-width: 400px) {
        flex-direction: column;
      }
      }

      .post-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 7;
        min-width: 0;
      }

      .post-image {
        flex: 3;
        min-width: 0;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;

        .image {
          width: 100%;
          height: 100%;
          object-fit: cover;
          max-height: 100px;
          border-radius: 4px;
        }
      }
    }

    .post-item-hidden {
      display: none;
    }

    .card {
      position: relative;
      padding: 16px;
    }
    .title {
      font-size: rem(20px);
      font-weight: 700;
      word-break: keep-all;
    }
    .subtitle {
      color: $grey-400;
      font-size: rem(12px);
    }

    .expand-button {
      width: 100%;
      color: $font-grey;
      margin-top: 16px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: rem(14px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      border: 1px solid $grey-200;

      &:hover {
        border-color: $grey-400;
        color: $font-black;
      }

      &:active {
        transform: scale(0.98);
      }
    }

    .expand-button.hidden {
      display: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const expandButtons = document.querySelectorAll('.expand-button')
    
    expandButtons.forEach(button => {
      button.addEventListener('click', () => {
        const section = button.closest('.home-posts')
        const hiddenItems = section?.querySelectorAll('.post-item-hidden')
        
        if (hiddenItems) {
          hiddenItems.forEach(item => {
            item.classList.remove('post-item-hidden')
          })
          button.classList.add('hidden')
        }
      })
    })
  })
</script>
